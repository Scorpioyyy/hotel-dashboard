# 002-RAGç³»ç»Ÿé›†æˆå®æ–½è§„åˆ’

## é¡¹ç›®æ¦‚è¿°

**ç›®æ ‡**ï¼šå°†å®Œæ•´çš„ Python RAG ç³»ç»Ÿé›†æˆåˆ° Next.js é¡¹ç›®ä¸­ï¼Œæ›¿æ¢å½“å‰ç®€å•çš„æ™ºèƒ½é—®ç­”å®ç°ã€‚

**å…³é”®çº¦æŸ**ï¼š
- âœ… **å‰ç«¯ UI å®Œå…¨ä¸å˜**ï¼ˆåªä¿®æ”¹åç«¯é€»è¾‘ï¼‰
- âœ… **ç¦ç”¨ HyDE å¬å›**ï¼ˆ`enable_hyde=False`ï¼‰
- âœ… **ä½¿ç”¨é»˜è®¤å‚æ•°**ï¼ˆæ¨¡å‹ã€æƒé‡ã€æ—¶æ•ˆæ€§ï¼‰
- âœ… **Anaconda base ç¯å¢ƒ**ï¼ˆæ— éœ€è™šæ‹Ÿç¯å¢ƒï¼‰

---

## æŠ€æœ¯æ¶æ„

### å½“å‰å®ç°
- **æ¡†æ¶**ï¼šNext.js 15 + TypeScript
- **æ•°æ®åº“**ï¼šInsforge (PostgreSQL)
- **AI**ï¼šInsforge AI SDK â†’ Gemini 3 Flash Preview
- **é—®ç­”é€»è¾‘**ï¼šç®€å•çš„ç±»åˆ«åŒ¹é… + é«˜è´¨é‡è¯„è®ºæ£€ç´¢ + ç”Ÿæˆ

### ç›®æ ‡æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js å‰ç«¯   â”‚ (Vercel)
â”‚  - è¯„è®ºæµè§ˆ     â”‚
â”‚  - æ•°æ®çœ‹æ¿     â”‚
â”‚  - æ™ºèƒ½é—®ç­” UI  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ HTTP API
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Python FastAPI  â”‚ (Railway/æœ¬åœ°)
â”‚  - æ„å›¾è¯†åˆ«     â”‚
â”‚  - 5è·¯æ··åˆæ£€ç´¢  â”‚
â”‚  - Reranké‡æ’   â”‚
â”‚  - æµå¼ç”Ÿæˆ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Insforge + å‘é‡åº“â”‚
â”‚  - PostgreSQL   â”‚
â”‚  - DashVector   â”‚
â”‚  - ChromaDB     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### Q1: Next.js èƒ½å¦ç›´æ¥è¿è¡Œ Python ä»£ç ï¼Ÿ
**ç­”æ¡ˆ**ï¼šâŒ ä¸èƒ½

**è§£å†³æ–¹æ¡ˆ**ï¼šFastAPI åç«¯æœåŠ¡
- Python RAG ç³»ç»Ÿå°è£…ä¸ºç‹¬ç«‹çš„ FastAPI æœåŠ¡
- Next.js é€šè¿‡ HTTP API è°ƒç”¨ Python æœåŠ¡
- éƒ¨ç½²ï¼šNext.js (Vercel) + Python (Railway)

### Q2: æ˜¯å¦éœ€è¦å®‰è£… Python ç¯å¢ƒï¼Ÿ
**ç­”æ¡ˆ**ï¼š
- **å¼€å‘ç¯å¢ƒ**ï¼šä½¿ç”¨ Anaconda base ç¯å¢ƒ
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šRailway è‡ªåŠ¨å¤„ç† Python ç¯å¢ƒ

### Q3: API Key å¦‚ä½•é…ç½®ï¼Ÿ
**ç­”æ¡ˆ**ï¼šç¯å¢ƒå˜é‡é…ç½®

**å¼€å‘ç¯å¢ƒ** (`.env`)ï¼š
```bash
# Insforge
NEXT_PUBLIC_INSFORGE_BASE_URL=https://your-project.insforge.dev
NEXT_PUBLIC_INSFORGE_ANON_KEY=your_anon_key

# DashScope
DASHSCOPE_API_KEY=sk-xxxxx

# DashVector
DASHVECTOR_API_KEY=xxxxx
DASHVECTOR_HOTEL_ENDPOINT=xxxxx

# Python API (å¼€å‘)
NEXT_PUBLIC_PYTHON_API_URL=http://localhost:8000
```

### Q4: è¯„è®ºæ•°æ®ä»å“ªé‡Œè¯»å–ï¼Ÿ
**ç­”æ¡ˆ**ï¼šâœ… ä» Insforge æ•°æ®åº“è¯»å–

**åŸå› **ï¼š
- ä¿æŒå‰åç«¯æ•°æ®ä¸€è‡´æ€§
- æ”¯æŒæ•°æ®åŠ¨æ€æ›´æ–°
- ç¬¦åˆé¡¹ç›®æ¶æ„è®¾è®¡

### Q5: å€’æ’ç´¢å¼•æ–‡ä»¶å¦‚ä½•å¤„ç†ï¼Ÿ
**ç­”æ¡ˆ**ï¼šå­˜å‚¨åœ¨ Python æœåŠ¡å™¨æ–‡ä»¶ç³»ç»Ÿ

**åŸå› **ï¼š
- `inverted_index.pkl` æ˜¯ Python pickle æ–‡ä»¶
- JavaScript æ— æ³•è¯»å–
- å¿…é¡»åœ¨ Python ç¯å¢ƒä¸­åŠ è½½

### Q6: æ˜¯å¦éœ€è¦æ‹†åˆ†ä»£ç ï¼Ÿ
**ç­”æ¡ˆ**ï¼šâœ… å¿…é¡»æ‹†åˆ†

**åŸå› **ï¼š
- å½“å‰ `lib.py` æœ‰ 1769 è¡Œä»£ç 
- è¿åå•ä¸€èŒè´£åŸåˆ™
- éš¾ä»¥ç»´æŠ¤å’Œæµ‹è¯•

---

## å®æ–½é˜¶æ®µ

### Phase 1: ä»£ç æ‹†åˆ†ä¸é‡æ„ ğŸ”´ P0

**ç›®æ ‡**ï¼šå°† `rag/lib.py` (1769è¡Œ) æ‹†åˆ†ä¸ºæ¨¡å—åŒ–ç»“æ„

**ç›®å½•ç»“æ„**ï¼š
```
rag-service/
â”œâ”€â”€ main.py                   # FastAPI å…¥å£
â”œâ”€â”€ requirements.txt          # Python ä¾èµ–
â”œâ”€â”€ config.py                 # é…ç½®ï¼ˆAPI Keysã€å¸¸é‡ï¼‰
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ clients.py            # LLMClient, EmbeddingClient
â”‚   â”œâ”€â”€ index.py              # InvertedIndex
â”‚   â”œâ”€â”€ intent.py             # æ„å›¾è¯†åˆ«/æ£€æµ‹/æ‰©å±•
â”‚   â”œâ”€â”€ retriever.py          # HybridRetriever
â”‚   â”œâ”€â”€ ranker.py             # Reranker, MultiFactorRanker
â”‚   â”œâ”€â”€ generator.py          # ResponseGenerator
â”‚   â””â”€â”€ rag_system.py         # HotelReviewRAG (æ•´åˆç±»)
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ formatting.py         # æ‰“å°å‡½æ•°
â”‚   â””â”€â”€ database.py           # Insforge è¿æ¥
â””â”€â”€ data/
    â”œâ”€â”€ inverted_index.pkl
    â””â”€â”€ chroma_db/
```

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] é‡å‘½å `rag/` â†’ `rag-service/`
- [ ] åˆ›å»ºç›®å½•ç»“æ„
- [ ] æ‹†åˆ† `lib.py` ä¸º 8 ä¸ªæ¨¡å—æ–‡ä»¶
- [ ] åˆ›å»º `requirements.txt`
- [ ] æµ‹è¯•æ‹†åˆ†ååŠŸèƒ½

**éªŒè¯**ï¼šè¿è¡Œ `example.py` ç¡®ä¿åŠŸèƒ½æ­£å¸¸

---

### Phase 2: æ•°æ®æºæ”¹é€  ğŸŸ  P1

**ç›®æ ‡**ï¼šè¯„è®ºæ•°æ®ä» CSV æ”¹ä¸º Insforge æ•°æ®åº“è¯»å–

**æ•°æ®æºæ˜ å°„**ï¼š
| æ•°æ®ç±»å‹ | å½“å‰æ¥æº | æ”¹é€ å |
|---------|---------|--------|
| è¯„è®ºæ•°æ® | CSV | Insforge æ•°æ®åº“ |
| å€’æ’ç´¢å¼• | PKL | æœåŠ¡å™¨æ–‡ä»¶ç³»ç»Ÿ |
| ç±»åˆ«æ‘˜è¦ | ChromaDB | ChromaDB (ä¸å˜) |
| è¯„è®ºå‘é‡ | DashVector | DashVector (ä¸å˜) |
| åå‘Query | DashVector | DashVector (ä¸å˜) |

**å®ç°ä»£ç ** (`utils/database.py`)ï¼š
```python
import os
import pandas as pd
import requests

def get_all_comments_from_insforge() -> pd.DataFrame:
    """ä» Insforge æ•°æ®åº“è·å–æ‰€æœ‰è¯„è®º"""
    base_url = os.getenv("NEXT_PUBLIC_INSFORGE_BASE_URL")
    anon_key = os.getenv("NEXT_PUBLIC_INSFORGE_ANON_KEY")

    headers = {
        "apikey": anon_key,
        "Authorization": f"Bearer {anon_key}",
        "Content-Type": "application/json"
    }

    all_data = []
    batch_size = 1000
    offset = 0

    while True:
        url = f"{base_url}/rest/v1/comments?select=*&offset={offset}&limit={batch_size}"
        response = requests.get(url, headers=headers)
        data = response.json()

        if not data:
            break

        all_data.extend(data)
        if len(data) < batch_size:
            break
        offset += batch_size

    df = pd.DataFrame(all_data).set_index("_id")
    return df
```

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] åˆ›å»º `utils/database.py`
- [ ] å®ç° `get_all_comments_from_insforge()`
- [ ] ä¿®æ”¹ `rag_system.py` åˆå§‹åŒ–
- [ ] é…ç½®ç¯å¢ƒå˜é‡
- [ ] æµ‹è¯•æ•°æ®åŠ è½½

---

### Phase 3: FastAPI æœåŠ¡æ„å»º ğŸŸ¡ P1

**ç›®æ ‡**ï¼šåˆ›å»º FastAPI åç«¯ï¼Œæä¾› RAG é—®ç­” API

**API è®¾è®¡**ï¼š

**POST /api/v1/chat**
```typescript
Request:  { "query": "å¥—æˆ¿ç©ºé—´å¤§å—ï¼Ÿ" }
Response: Stream of SSE events
  - {"type": "chunk", "content": "..."}
  - {"type": "done", "timing": {...}, "references": {...}}
```

**GET /api/v1/health**
```json
{ "status": "ok", "version": "1.0.0" }
```

**RAG é…ç½®** (`main.py`)ï¼š
```python
DEFAULT_RAG_OPTIONS = {
    "enable_hyde": False,      # âš ï¸ ç¦ç”¨ HyDE
    "enable_bm25": True,
    "enable_vector": True,
    "enable_reverse": True,
    "enable_summary": True,
    "enable_ranking": True,
    "retrieval_topk": 100,
    "ranking_topk": 10,
}
```

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] åˆ›å»º `main.py`
- [ ] å®ç° `/api/v1/chat` æ¥å£
- [ ] å®ç° `/api/v1/health` æ¥å£
- [ ] é…ç½® CORS ä¸­é—´ä»¶
- [ ] è®¾ç½®é»˜è®¤å‚æ•°ï¼ˆç¦ç”¨ HyDEï¼‰
- [ ] æœ¬åœ°æµ‹è¯•

**å¯åŠ¨å‘½ä»¤**ï¼š
```bash
conda activate base
pip install -r requirements.txt
uvicorn main:app --reload --port 8000
```

---

### Phase 4: Next.js å‰ç«¯é›†æˆ ğŸŸ¢ P1

**ç›®æ ‡**ï¼šä¿®æ”¹ `src/lib/qa.ts`ï¼Œä¿æŒæ¥å£å…¼å®¹

**âš ï¸ å…³é”®çº¦æŸ**ï¼š
- **UI å®Œå…¨ä¸å˜**ï¼š`src/app/qa/page.tsx` ä¸æ”¹
- **æ¥å£ä¸å˜**ï¼šä¿æŒç°æœ‰å‡½æ•°ç­¾å
- **è¡Œä¸ºä¸€è‡´**ï¼šAsyncGenerator yield è¡Œä¸ºä¸å˜

**å½“å‰æ¥å£** (ä¸èƒ½æ”¹)ï¼š
```typescript
export async function getReferencesForQuestion(question: string): Promise<Comment[]>

export async function* askQuestionStream(
  question: string,
  references: Comment[],
  signal?: AbortSignal
): AsyncGenerator<string, void, unknown>
```

**æ–°å®ç°**ï¼š
```typescript
const PYTHON_API_URL = process.env.NEXT_PUBLIC_PYTHON_API_URL || 'http://localhost:8000';

export async function getReferencesForQuestion(question: string): Promise<Comment[]> {
  const response = await fetch(`${PYTHON_API_URL}/api/v1/chat`, {
    method: 'POST',
    body: JSON.stringify({
      query: question,
      options: { enable_generation: false }  // åªæ£€ç´¢
    })
  });

  const result = await response.json();
  return result.references.comments.map(convertToComment);
}

export async function* askQuestionStream(
  question: string,
  references: Comment[],
  signal?: AbortSignal
): AsyncGenerator<string, void, unknown> {
  const response = await fetch(`${PYTHON_API_URL}/api/v1/chat`, {
    method: 'POST',
    body: JSON.stringify({ query: question }),
    signal
  });

  const reader = response.body?.getReader();
  const decoder = new TextDecoder();

  while (true) {
    if (signal?.aborted) return;

    const { done, value } = await reader.read();
    if (done) break;

    const chunk = decoder.decode(value);
    const lines = chunk.split('\n\n');

    for (const line of lines) {
      if (line.startsWith('data: ')) {
        const event = JSON.parse(line.slice(6));
        if (event.type === 'chunk') {
          yield event.content;
        }
      }
    }
  }
}
```

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] ä¿®æ”¹ `src/lib/qa.ts` å®ç°
- [ ] æ·»åŠ ç¯å¢ƒå˜é‡ `NEXT_PUBLIC_PYTHON_API_URL`
- [ ] æµ‹è¯•æ¥å£å…¼å®¹æ€§
- [ ] æœ¬åœ°è”è°ƒæµ‹è¯•

**ä¸éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
- âŒ `src/app/qa/page.tsx`
- âŒ `src/lib/qa-background.ts`
- âŒ `src/components/qa/*`

---

### Phase 5: éƒ¨ç½² (å¯é€‰) ğŸ”µ P2

**Python æœåŠ¡ (Railway)**ï¼š
1. åˆ›å»º `Procfile`: `web: uvicorn main:app --host 0.0.0.0 --port $PORT`
2. åˆ›å»º `runtime.txt`: `python-3.11`
3. æ¨é€åˆ° GitHub
4. Railway è¿æ¥ä»“åº“å¹¶éƒ¨ç½²
5. é…ç½®ç¯å¢ƒå˜é‡

**Next.js å‰ç«¯ (Vercel)**ï¼š
1. é…ç½®ç¯å¢ƒå˜é‡
2. æ¨é€åˆ° GitHub
3. Vercel è‡ªåŠ¨éƒ¨ç½²

---

## éªŒè¯æ ‡å‡†

### åŠŸèƒ½éªŒè¯
- [ ] è¯„è®ºæµè§ˆé¡µé¢æ­£å¸¸ï¼ˆç­›é€‰ã€æ’åºã€åˆ†é¡µï¼‰
- [ ] æ•°æ®çœ‹æ¿æ­£å¸¸ï¼ˆå›¾è¡¨ã€ç»Ÿè®¡ï¼‰
- [ ] æ™ºèƒ½é—®ç­”æµå¼è¾“å‡º
- [ ] æ˜¾ç¤º Top-10 å‚è€ƒè¯„è®º
- [ ] æ”¯æŒç»ˆæ­¢ç”Ÿæˆ
- [ ] ä¼šè¯å†å²ä¿å­˜

### æ€§èƒ½éªŒè¯
- [ ] é¦–å­—å»¶è¿Ÿ (TTFT) < 3ç§’
- [ ] æ£€ç´¢ + é‡æ’ < 2ç§’
- [ ] å®Œæ•´å›å¤ < 10ç§’

### ä»£ç è´¨é‡
- [ ] æ¯ä¸ªæ¨¡å— < 300 è¡Œ
- [ ] æ— å¾ªç¯ä¾èµ–
- [ ] æœ‰é€‚å½“æ³¨é‡Š

---

## å…³é”®é£é™©

### é£é™© 1: æ•°æ®æ ¼å¼ä¸ä¸€è‡´
**ç¼“è§£**ï¼šå…ˆè¯»å–å°‘é‡æ•°æ®éªŒè¯å­—æ®µï¼Œæ·»åŠ æ•°æ®è½¬æ¢é€»è¾‘

### é£é™© 2: å¾ªç¯ä¾èµ–
**ç¼“è§£**ï¼šéµå¾ªä¾èµ–å±‚æ¬¡ utils â†’ modules â†’ rag_system â†’ main

### é£é™© 3: CORS è·¨åŸŸ
**ç¼“è§£**ï¼šFastAPI é…ç½® CORS ä¸­é—´ä»¶ï¼Œå…è®¸ Next.js åŸŸå

### é£é™© 4: æµå¼å“åº”å¤æ‚
**ç¼“è§£**ï¼šä½¿ç”¨ SSE æ ‡å‡†ï¼Œå‚è€ƒ OpenAI API å®ç°

---

## å·¥ä½œé‡é¢„ä¼°

| é˜¶æ®µ | ä»»åŠ¡ | é¢„ä¼°æ—¶é—´ | ç¯å¢ƒ |
|-----|------|---------|------|
| Phase 1 | ä»£ç æ‹†åˆ† | 3-4h | Anaconda base |
| Phase 2 | æ•°æ®æºæ”¹é€  | 1-2h | Anaconda base |
| Phase 3 | FastAPI æœåŠ¡ | 2-3h | Anaconda base |
| Phase 4 | å‰ç«¯é›†æˆ | 1-2h | Node.js |
| Phase 5 | éƒ¨ç½² | 1-2h | äº‘æœåŠ¡ |
| **æ€»è®¡** | | **8-13h** | |

---

## ä¾èµ–åº“

**Python** (`requirements.txt`)ï¼š
```txt
fastapi
uvicorn[standard]
pydantic
python-dotenv
requests
pandas
numpy
nltk
jieba
dashscope
dashvector-client
chromadb
tqdm
```

**Next.js** (å·²æœ‰)ï¼š
```json
{
  "@insforge/sdk": "^1.1.1",
  "next": "^15.5.7",
  "react": "^19.2.3"
}
```

---

## ç¯å¢ƒå˜é‡æ¸…å•

**Python æœåŠ¡** (`rag-service/.env`)ï¼š
```bash
DASHSCOPE_API_KEY=sk-xxxxx
DASHVECTOR_API_KEY=xxxxx
DASHVECTOR_HOTEL_ENDPOINT=xxxxx
NEXT_PUBLIC_INSFORGE_BASE_URL=https://your-project.insforge.dev
NEXT_PUBLIC_INSFORGE_ANON_KEY=your_anon_key
```

**Next.js å‰ç«¯** (`.env.local`)ï¼š
```bash
NEXT_PUBLIC_PYTHON_API_URL=http://localhost:8000
NEXT_PUBLIC_INSFORGE_BASE_URL=https://your-project.insforge.dev
NEXT_PUBLIC_INSFORGE_ANON_KEY=your_anon_key
```

---

## é¡¹ç›®æ–‡ä»¶æ˜ å°„

```
å½“å‰ç»“æ„                    â†’  ç›®æ ‡ç»“æ„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
rag/lib.py (1769è¡Œ)         â†’  rag-service/modules/*.py
rag/example.py              â†’  rag-service/test_rag.py
public/inverted_index.pkl   â†’  rag-service/data/inverted_index.pkl
                            â†’  rag-service/main.py (æ–°å¢)
src/lib/qa.ts               â†’  ä¿®æ”¹å®ç° (æ¥å£ä¸å˜)
src/app/qa/page.tsx         â†’  ä¸æ”¹
```

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… **å·²å®Œæˆ**ï¼šåˆ›å»ºå®æ–½è§„åˆ’æ–‡æ¡£
2. â­ï¸ **ä¸‹ä¸€æ­¥**ï¼šæ‰§è¡Œ `/speckit.specify` åˆ›å»º 002 ç‰¹æ€§è§„èŒƒ
3. â­ï¸ **åç»­**ï¼šæŒ‰ç…§ Phase 1-5 é€æ­¥å®æ–½

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**ï¼š2026-02-12
**åˆ†æ”¯**ï¼š002-rag-system
**çŠ¶æ€**ï¼šè§„åˆ’å®Œæˆï¼Œå¾…æ‰§è¡Œ
